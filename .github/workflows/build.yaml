name: Build

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
      - "release/**"
  workflow_dispatch:

jobs:
  py-ruff:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11"]
    steps:
      - uses: actions/checkout@v4
      - name: Lint with Ruff
        uses: chartboost/ruff-action@v1
      - name: Format with Ruff
        uses: chartboost/ruff-action@v1
        with:
          args: "format --check"

  py-mypy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11"]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt', '**/pyproject.toml') }}-${{ matrix.python-version }}
          restore-keys: |
            ${{ runner.os }}-pip-
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install git+https://github.com/UKGovernmentBEIS/inspect_ai.git
          python -m pip install .[dev]
      - name: Run mypy
        run: |
          mypy src examples tests --python-executable $(which python)

  py-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11"]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt', '**/pyproject.toml') }}-${{ matrix.python-version }}
          restore-keys: |
            ${{ runner.os }}-pip-
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install git+https://github.com/UKGovernmentBEIS/inspect_ai.git
          python -m pip install .[dev]
      - name: Run tests
        run: pytest

  py-build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11"]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install git+https://github.com/UKGovernmentBEIS/inspect_ai.git
          python -m pip install build
      - name: Build package
        run: python -m build
      - name: Verify package
        run: |
          python -m pip install dist/*.whl
          python -c "import inspect_scout; print('Package imported successfully')"

  openapi-schema:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt', '**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install git+https://github.com/UKGovernmentBEIS/inspect_ai.git
          python -m pip install .
      - name: Export OpenAPI schema
        run: python scripts/export_openapi_schema.py
      - name: Check schema is up-to-date
        run: |
          if ! git diff --exit-code src/inspect_scout/_view/www/openapi.json
          then
            echo "❌ openapi.json is out of sync with Python API code!"
            echo ""
            echo "The OpenAPI schema has changed. Please run:"
            echo "  .venv/bin/python scripts/export_openapi_schema.py"
            echo ""
            echo "Then commit the updated openapi.json file."
            exit 1
          fi

  js-lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          package_json_file: src/inspect_scout/_view/www/package.json

      - name: Install Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: src/inspect_scout/_view/www/pnpm-lock.yaml

      - name: Install dependencies
        working-directory: src/inspect_scout/_view/www
        run: pnpm install --frozen-lockfile

      - name: Check linting
        working-directory: src/inspect_scout/_view/www
        run: pnpm lint

  js-typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          package_json_file: src/inspect_scout/_view/www/package.json

      - name: Install Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: src/inspect_scout/_view/www/pnpm-lock.yaml

      - name: Install dependencies
        working-directory: src/inspect_scout/_view/www
        run: pnpm install --frozen-lockfile

      - name: Check typechecking
        working-directory: src/inspect_scout/_view/www
        run: pnpm typecheck

  js-format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          package_json_file: src/inspect_scout/_view/www/package.json

      - name: Install Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: src/inspect_scout/_view/www/pnpm-lock.yaml

      - name: Install dependencies
        working-directory: src/inspect_scout/_view/www
        run: pnpm install --frozen-lockfile

      - name: Check formatting
        working-directory: src/inspect_scout/_view/www
        run: pnpm format:check

  js-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          package_json_file: src/inspect_scout/_view/www/package.json

      - name: Install Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: src/inspect_scout/_view/www/pnpm-lock.yaml

      - name: Install dependencies
        working-directory: src/inspect_scout/_view/www
        run: pnpm install --frozen-lockfile

      - name: Generate TypeScript types from OpenAPI
        working-directory: src/inspect_scout/_view/www
        run: pnpm types:generate

      - name: Check generated types are up-to-date
        working-directory: src/inspect_scout/_view/www
        run: |
          if ! git diff --exit-code src/types/generated.ts
          then
            echo "❌ generated.ts is out of sync with openapi.json!"
            echo ""
            echo "TypeScript types need to be regenerated. Run:"
            echo "  cd src/inspect_scout/_view/www"
            echo "  pnpm types:generate"
            echo ""
            echo "Then commit the updated src/types/generated.ts file."
            exit 1
          fi

      - name: Build package
        working-directory: src/inspect_scout/_view/www
        run: pnpm build

      - name: Check build output is clean
        working-directory: src/inspect_scout/_view/www
        run: |
          if ! git diff --exit-code
          then
            echo "❌ Build produced unexpected changes!"
            echo ""
            echo "Files changed during build:"
            git diff --name-only
            exit 1
          fi

  js-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          package_json_file: src/inspect_scout/_view/www/package.json

      - name: Install Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: src/inspect_scout/_view/www/pnpm-lock.yaml

      - name: Install dependencies
        working-directory: src/inspect_scout/_view/www
        run: pnpm install --frozen-lockfile

      - name: Run tests
        working-directory: src/inspect_scout/_view/www
        run: pnpm test
